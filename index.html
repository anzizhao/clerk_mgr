<!DOCTYPE html>
<html lang="zh-cmn-Hans">
<head>
	<meta charset="UTF-8">
	<title>店员管理</title>
	<meta name="renderer" content="webkit">
	<meta http-equiv="X-UA-Compatible" content="IE=edge">
	<meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no" />
	<meta name="apple-mobile-web-app-status-bar-style" content="black" />
	<meta name="format-detection" content="telephone=no, email=no" />
	<meta name="apple-mobile-web-app-capable" content="yes" />
	<meta name="x5-fullscreen" content="true">
	<link rel="stylesheet" type="text/css" href="css/weui.min.css">
	<link rel="stylesheet" href="css/clerk_management.css" />
	<script type="text/javascript" src="js/template.js"></script>
	<script type="text/javascript" src="js/director.min.js"></script>
</head>
<body class="bg_efe">

	<div id="content"></div>

	<!-- 店员管理首页 -->
	<script id="js-clerk_list" type="text/html">
		{{if section[0].list.length != 0}}
			<div class="date-select">
				<label class="lbl">时间:</label>
				<select id="js-select-date" class="select">
					{{ each time as item i }}
					<option value="{{item.value}}">{{item.text}}</option>
					{{/each}}
				</select>
			</div>
			
			{{ each section as group i }}
				<div class="list-title">{{group.title}}</div>
				{{ if group.eleId }}
				<ul id="list" class="list user_list">
				{{ else }}
				<ul class="list user_list">
				{{ /if}}
				    {{each group.list as entry i}}
						<li class="item">
							<div class="btn_edit list_item_edit" data-id="{{entry.clerkId}}">编辑资料</div>
							<div class="btn_del list_item_del" data-id="{{entry.clerkId}}" >删除</div>
                            <a href="{{'#/details/' + entry.clerkId }}" class="clerk-item">
								<span class="name">{{ entry.name }}</span>
								<p class="item-bottom">
									<span class="order_num icons">{{ entry.order_num }}笔</span>
									<span class="money_num icons">{{ entry.money_num }}元</span>
								</p>
							</a>
						</li>
				    {{/each}}
				</ul>
		    {{/each}}

		    <div class="btn_group tc btn_group_bottom">
				<a class="btn btn-single" href="">添加店员</a>
			</div>
		    {{else}}
		    <div class="tc">
		    	<img class="img-null" src="img/img-null.png">
		    	<p class="clerk-null-txt">您还没有添加店员喔，现在去添加吧！</p>
		    	<div class="btn_group">
		    		<a href="" class="btn btn_save">马上添加店员</a>
		    	</div>
		    </div>
	    {{/if}}
	    <div class="warm-tips">
	    	<i class="warm-tips-txt">扫描店长的桌牌进行支付，店员收不到消息的</i>
	    	<i class="icons ico-bulbs"></i>
    	</div>
	</script>

	<!-- 店员详情－顶部 -->
	<script id="js-clerk_details_top" type="text/html">
		<ul class="list user_list user_list_details">
			<li class="item">
				<a href="javascript:;">
					<span class="name">{{ entry.name }}</span>
					<p class="item-bottom">
						<span class="order_num icons">{{ entry.order_num }}笔</span>
						<span class="money_num icons">{{ entry.money_num }}元</span>
					</p>
					<span id="js-ico-setup" class="ico-setup"></span>
				</a>
			</li>
	    </ul>
	</script>
	<!-- 店员详情－交易流水 -->
	<script id="js-clerk_details_list" type="text/html">
		{{each main as entry i}}
			<div class="listview clerk-details-list">
				<div class="mon">
					<p class="time">{{ entry.date }}</p>
					<p>实收金额：<span class="font-num">¥{{ entry.totalPaidIn }}</span></p>
				</div>
				{{each main[i].details as item}}
					<div class="list-item">
						<div class="l">
                            <div class="l-name">[{{ item.payType }}]订单金额¥{{ item.orderAmount }}，商家优惠¥{{ item.coupon }}</div>
							<div class="l-time">
								<p>{{ item.time }}</p>
							</div>
						</div>
						<div class="r">¥{{ item.paidIn }}</div>	
					</div>
				{{/each}}
			</div>
		{{/each}}
        <div id="navigation"><a href="{{'/api/detail/'+ clerkId + '/list?date='  + date + '&page=1' }}"></a></div>
	</script>

	<!-- 店员详情 -->
	<script id="js-clerk_details" type="text/html">
		{{include 'js-clerk_details_top'}}
		{{include 'js-weui-actionSheet'}}
		<div id="masonny-div">
			{{include 'js-clerk_details_list'}}
		</div>
		<div class="loading"></div>
	</script>

	<!-- 修改店员信息 -->
	<script id="js-edit-list" type="text/html">
		<ul class="list edit-list">
			<li>
				<a href="">修改密码</a>
			</li>
			<li>
				{{if isBound}}
					<a href="">查看桌牌<span class="bound">已绑定</span></a>
					{{else}}
					<a href="javascript:;" id="bindcard-button">绑定桌牌</a>
				{{/if}}
			</li>
		</ul>
	</script>

	<!-- 绑定桌牌 -->
	<script id="js-bind-card" type="text/html">
		<div class="bind-card">
			<div class="form-item">
				<label class="form-lbl">绑定桌牌:</label>
				<input class="form-txt sn-no" type="text" placeholder="请输入您要绑定的桌牌上的商户号">
			</div>
			<div class="tips">
				<i class="ico-tips icons"></i>
				<i class="tips-txt">每个商户号只能绑定一个帐号（请勿使用店主帐号所绑定的桌牌进行重复绑定）</i>
			</div>
			<div class="btn_group">
				<div class="btn btn_save disabled">保存</div>
			</div>
		</div>
	</script>

	<!-- weui-actionSheet -->
	<script id="js-weui-actionSheet" type="text/html">
		<div id="actionSheet_wrap">
		    <div class="weui_mask_transition" id="mask"></div>
		    <div class="weui_actionsheet" id="weui_actionsheet">
		        <div class="weui_actionsheet_menu">
		            <div id="js-actionsheet-editList" class="weui_actionsheet_cell">编辑店员信息</div>
		            <div id="js-del-clerk" class="weui_actionsheet_cell">删除成员</div>
		        </div>
		        <div class="weui_actionsheet_action">
		            <div class="weui_actionsheet_cell" id="actionsheet_cancel">取消</div>
		        </div>
		    </div>
		</div>
	</script>
	<div id="js_muck" class="layer">
		<div class="tipbox">
			<div class="ico-header"> <img src="img/userpho.png" class="userpho"> </div>
			<button id="js_closeMsg" class="bg_icon1 close"></button>
			<div class="clear"></div>
			<h1 class="tip-name">报告老板</h1>
			<div class="bg_icon1 coner"></div>
			<p class="p" id="msg">消息内容</p>
			<div id="single_btn" class="single_btn">
				<button class="btn btn-normal"></button>
			</div>
			<div id="double_btn" class="double_btn">
				<button id="js_del" class="btn btn-cancel">确认</button>
				<button class="btn btn-ok" onclick="hideMsg()">取消</button>
			</div>
			
		</div>
	</div>
	<script type="text/javascript" src="js/jquery.min.js"></script>
	<script type="text/javascript" src="js/etouch1.0.js"></script>
	<script type="text/javascript" src="js/jquery-infinite-scroll/jquery.infinitescroll.js"></script>
	<script type="text/javascript" src="js/clerk.js"></script>
	<script type="text/javascript">
        // 全局数据
		// 店员管理首页
		var clerk_list_data = {
			time: [],
			section: []
		};
        var opState ={
            list: {}, 
            detail:{},
        }

		var list = function () { 
            // 初始化状态
            // api 的状态
            var listUrl = '/api/list'
            var dateUrl = '/api/date'
            var apiStatus = {
                date: false, 
                list: false,
            }
            // 操作状态
            opState.list.timSelect =  null

			$.getJSON( dateUrl, function(data){
				if(data.error == 0){
					clerk_list_data.time = data.data.time;
                    apiStatus.date = true
                    shouldRender();
				}
			})


            getList(null,function(){
                    apiStatus.list = true ;
                    shouldRender();
                })

            function getList(params, fn){
                var url 
                var urlObj = {}
                if( params &&  params.date ) {
                    urlObj = {
                        date: params.date 
                    }
                }

                $.getJSON( listUrl, urlObj, function(data) {
                    if(data.error == 0){
                        clerk_list_data.section = data.data.section;
                        if( fn instanceof Function ) {
                            fn() 
                        }
                    }
                });
            
            }
            // 渲染list 页面 
            function render(){
                var clerk_list_html = template('js-clerk_list', clerk_list_data);
                document.getElementById('content').innerHTML = clerk_list_html;
                init();
            }
            function shouldRender(){
                if( apiStatus.date && apiStatus.list )  {
                    render() 
                }
            }
            function wrapDelClerk(clerkId){
                function delClerk(){
                    var url = '/api/clerkDel'
                    $.post(url, { clerkId: clerkId}, function(data){
                            //TODO 根据删除结果  做处理 
                            var params = {  date: opState.list.timeSelect  }
                            if( data.error === 0 ) {
                                getList(params, function(){
                                    render();
                                    // 重新选中
                                    $("#js-select-date").val( opState.list.timeSelect )
                                    })
                                }
                                hideMsg()
                            });
                }
                return delClerk
            }

            function init(){
                moveDel();
                $(".list_item_edit").click(function(){
                        var id = $(this).attr('data-id');
                        window.location.href = "#/editList/"+id;
                        });


                $(".list_item_del").click(function(e){
                        e.stopPropagation();
                        var id = $(this).attr('data-id');
                        showMsg("删除店员后，该账号将无法再登录，<br>且不能以同样的账号再添加店员，<br>确认删除吗？",2, null, wrapDelClerk(id) );
                        });

                $("#js-select-date")
                    .change( function(){
                            opState.list.timeSelect = $(this).val()
                            var params = {  date: opState.list.timeSelect  }
                            getList(params, function(){
                                render();
                                // 重新选中
                                $("#js-select-date").val( opState.list.timeSelect )
                                })
                            });
            }

		};

		var details = function (clerkId) { 
            //初始化状态
            var clerk_details_data  =  {
                entry : null, 
                main: [],
                clerkId: clerkId,
                date: 1,
            } 
            var apiStatus = {
                detail: false, 
                detailList: false,
            }

            // 获取页面数据
            var params = null
            var timeSelect = opState.list.timeSelect
            if( timeSelect  ) {
                params = {
                    date: timeSelect 
                }; 
                clerk_details_data.date = timeSelect 
            }

            getDetail(params, function(){
                        // 获取数据后  渲染页面
                        apiStatus.detail = true
                        shouldRender()
                    })

            getDetailList(params, function(){
                        apiStatus.detailList = true
                        shouldRender()
                    })

            function shouldRender(){
                if( apiStatus.detail && apiStatus.detailList ) {
                    render() 
                    initInfiniteScroll()
                } 
            }

            // 渲染detail页面 
            function render(){
                var clerk_details_html = template('js-clerk_details', clerk_details_data);
                document.getElementById('content').innerHTML = clerk_details_html;

                init();
            }

            function renderMoreData(data) {
                var i = 0;
                var j = 0;
                var len = data.list.length;
                var db = clerk_details_data.main 
                var dbLen  = db.length 
                //特殊处理第一个  查看是否接着上一个日期
                if(  dbLen && db[dbLen-1].date === data.list[i].date ) {
                    data.list[i].details.forEach(function(item){
                            db[dbLen-1].details.push( item ) 
                            })
                } else {
                    db.push( data.list[i] ) 
                }
                for( i=1; i<len; i++) {
                    db.push( data.list[i] ) 
                }

                render()
            }

            function getDetail(params, fn ) {
                var url  =  "/api/detail/" + clerkId ;
                var urlParams  = {}
                if( params && params.date)  {
                    urlParams.date =  params.date 
                }

                $.getJSON(url, urlParams,  function(data){
                    if(data.error == 0){
                        clerk_details_data.entry = data.data;
                        if( fn instanceof Function ) {
                            fn() 
                        }
                    }
                })
            }
            function getDetailList(params, fn) {
                var url  =  "/api/detail/" + clerkId +  "/list"  ;
                var urlParams  = {}
                if( params && params.date)  {
                    urlParams.date =  params.date 
                }

                $.getJSON(url, urlParams, function(data){
                    if(data.error === 0){
                        data.data.list.forEach(function(item){
                            clerk_details_data.main.push(item);

                            })
                        // clerk_details_data.main.push(data.data);
                        if( fn instanceof Function ) {
                            fn() 
                        }
                    }
                })
            
            }
			
            function delClerk(){
                // var clerkId = clerkId
                var url = '/api/clerkDel'
                $.post(url, { clerkId: clerkId}, function(data){
                        //TODO 根据删除结果  做处理 
                        var params = {  date: opState.list.timeSelect  }
                        if( data.error === 0 ) {
                            getList(params, function(){
                                    render();
                                    // 重新选中
                                    $("#js-select-date").val( opState.list.timeSelect )
                                })
                        }

                                hideMsg()
                    })
            }


            function init(){
                //打开 actionSheet
                var mask = $('#mask');
                var weuiActionsheet = $('#weui_actionsheet');

                $("#js-ico-setup").click(function(){
                    showActionSheet( weuiActionsheet, mask );
                });

                $('#actionsheet_cancel').on('click', function () {
                    hideActionSheet(weuiActionsheet, mask);
                });

                //跳转 编辑店员信息
                $("#js-actionsheet-editList").click(function(){
                    var id = clerk_details_data.entry.clerkId;
                    window.location.href = "#/editList/"+id;
                })

                $("#js-del-clerk").click(function(){
                    hideActionSheet(weuiActionsheet, mask);
                    showMsg("删除店员后，该账号将无法再登录，<br>且不能以同样的账号再添加店员，<br>确认删除吗？", 2, null, delClerk)

                });
            }

            function initInfiniteScroll(){
                $('#masonny-div').infinitescroll({
                    state: {
                        currPage: 1    // 当前的页面 从2开始
                    },
                    navSelector  : "#navigation",   // 页面分页元素(成功后会被隐藏)
                    nextSelector : "#navigation a", // 需要点击的下一页链接，和2的html要对应
                    itemSelector : ".clerk-details-list"  , // ajax回来之后，每一项的selecter
                                              //（比如每篇文章都有item这个class）
                    debug: true, //启用调试信息
                    animate: false, //当有新数据加载进来的时候，页面是否有动画效果，默认没有
                    extraScrollPx: 150, //滚动条距离底部多少像素的时候开始加载，默认150
                    bufferPx: 40, //载入信息的显示时间，时间越大，载入信息显示时间越短
                    errorCallback: function(errorType) {
                        if( errorType === 'done'){
                            console.log('done')
                            //TODO 
                            // finish 
                        }
                    }, //当出错的时候，比如404页面的时候执行的函数
                    appendCallback: false,
                    pathParse: function(path, page){
                        var searchStr = 'page='
                        var pathComs = path.split( searchStr )
                        pathComs[0] +=  searchStr
                        pathComs[1] = ''
                        return pathComs 
                    },
                    localMode: true, //是否允许载入具有相同函数的页面，默认为false
                    dataType: 'json',//可以是json
                    loading: {
                        img: "img/loading.gif",
                        msgText: "",
                        finishedMsg: '没有更多记录了',
                        selector: '.loading', // 显示loading信息的div
                    }
                },function(retData, opt ) {
                    //程序执行完的回调函数
                    renderMoreData( retData.data )
                    //获取数据完成, 解除绑定 
                    if( ! retData.data.status )  {
                        $(window).unbind('.infscr')
                    }
                })
            }


            function showActionSheet( weuiActionsheet, mask ){
            	weuiActionsheet.addClass('weui_actionsheet_toggle');
	            mask.show().focus()//加focus是为了触发一次页面的重排(reflow or layout thrashing),使mask的transition动画得以正常触发
	                .addClass('weui_fade_toggle').one('click', function () {
		                hideActionSheet(weuiActionsheet, mask);
		            });
        	}
            
            function hideActionSheet(weuiActionsheet, mask) {
                weuiActionsheet.removeClass('weui_actionsheet_toggle');
                mask.hide().removeClass('weui_fade_toggle');
            }

		};

		var editList = function( clerkId ){
            var edit_list_data = {
                isBound: false 
            }		
			//修改店员信息
            var i=0;
            var list 
            if( ! clerk_list_data.section.length ) {
                getDetail(null, function(){
                       render() 
                       })
            } 
            else {
                list = clerk_list_data.section[0].list;
                if (! matchClerkId(list)) {
                    list = clerk_list_data.section[1].list;
                    matchClerkId(list)
                }
            }
            


            function matchClerkId(list){
                for(i=0; i<list.length; i++){
                    if(list[i].clerkId === clerkId ){
                        edit_list_data.isBound = list[i].isBound
                        render()
                        return true
                    }
                }
                return false 
            }

            function render(){
                var edit_list_html =  template('js-edit-list', edit_list_data);
                document.getElementById('content').innerHTML = edit_list_html;
                init()
            }

            function init(){
                //跳转绑定页面 
                $("#bindcard-button").click(function(){
                    window.location.href = "#/bindCard/"+clerkId;
                })
            
            }

            function getDetail(params, fn ) {
                var url  =  "/api/detail/" + clerkId ;
                var urlParams  = {}
                if( params && params.date)  {
                    urlParams.date =  params.date 
                }

                $.getJSON(url, urlParams,  function(data){
                    if(data.error == 0){
                        var i = 0
                        edit_list_data.isBound = data.data.isBound ;

                        if( fn instanceof Function ) {
                            fn() 
                        }
                    }
                })
            }


		}

		var bindCard  = function(clerkId){
			//绑定桌牌
			var bind_card_html = template('js-bind-card', {});
			document.getElementById('content').innerHTML = bind_card_html;

            $(".sn-no").keyup(function(){
                if($(this).val().trim() != ""){
                    $(".btn_save").removeClass("disabled");
                    $(".btn_save")[0].onclick = postData;
                }else {
                    $(".btn_save").addClass("disabled");
                    $(".btn_save")[0].onclick = null;
                }
            });


            function postData(){
                var snNo = $('.sn-no')[0].value
                var url = '/api/bindCard'
                var formObj = {
                    clerkId: clerkId,
                    shopNo: snNo,
                }
                $.post(url, formObj ,function(data, status){
                        // showMsg("请输入正确的商户号",1,"关闭");
                        showMsg("该商户已绑定其他账号",1,"关闭");

                        }, 'json') 
            }
		}

		// 路由配置
		var routes = {
			'/list': list,
			'/details/:id': details,
			'/editList/:id': editList,
			'/bindCard/:id': bindCard,
		}
		var router = Router(routes);

		router.init(['/list']);
	
	    function hideMsg(){
	    	$('#js_muck').hide();
	    	$('li a').removeClass('on').css({'-webkit-transform':'translate3d(0,0,0)','-webkit-transition':'all .2s ease'});
	    }
	    $('#js_closeMsg').click(hideMsg);

	    function showMsg(msg,length,btnName, fn){
	    	$('#js_muck').show();
	    	$('#single_btn,#double_btn').hide();
	    	if(length == 1){
		    	$('#single_btn').show();
		    	$('#single_btn .btn-normal').text(btnName).click(hideMsg);
	    	}
	    	if(length == 2){
		    	$('#double_btn').show();
	    	}
	    	$('#msg').html(msg);
            $('#js_del').click(function(){
                    if( fn instanceof Function) {
                        fn() 
                    } 
                    })
	    }

	</script>
</body>
</html>
